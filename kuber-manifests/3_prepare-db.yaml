apiVersion: batch/v1
kind: Job
metadata:
  name: prepare-database-job
  namespace: kolybelkin
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: prepare-database
          image: postgres:latest
          env:
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: db-secret
                  key: username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: common-postgresql
                  key: postgresql-password
            - name: PGHOST
              value: "common-postgresql"
          command:
            - sh
            - "-c"
            - |
              psql <<EOF
                CREATE TABLE users (id bigint GENERATED BY DEFAULT AS IDENTITY primary key, username varchar, first_name varchar, last_name varchar, email varchar, phone varchar);
                INSERT INTO users (id, username, first_name, last_name, email, phone) values (1, 'KolybelkinV', 'Viacheslav', 'Kolybelkin', 'kolybelkin@gmail.com', '+79093336666');
              EOF

  backoffLimit: 0